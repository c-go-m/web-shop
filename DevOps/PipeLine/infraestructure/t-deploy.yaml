parameters:  
  ServiceConnection: default
  ResourceGroupTerraform: default
  StoregeAccountTerraform: default
  TerraformContainer: default
  TerraformFile: default
  FileVar: default

stages:
- stage: Deploy
  jobs:
  - job: 'Deploy_Terraform'
    steps:

    - task: DownloadPipelineArtifact@2
      displayName: 'Get Artifact'
      inputs:
        artifact: drop
        path: $(Build.ArtifactStagingDirectory)       

    - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@1
      displayName: 'Install Terraform latest'
   

    - task: ms-devlabs.custom-terraform-tasks.custom-terraform-release-task.TerraformTaskV4@4
      displayName: 'Terraform : init'
      inputs:
        command: init
        workingDirectory: '$(Build.ArtifactStagingDirectory)'
        backendServiceArm: $(ServiceConnection)
        backendAzureRmResourceGroupName: $(ResourceGroupTerraform)
        backendAzureRmStorageAccountName: $(StoregeAccountTerraform)
        backendAzureRmContainerName: $(TerraformContainer)
        backendAzureRmKey: $(TerraformFile)  

    - script: | 
        chmod +x .terraform/providers/registry.terraform.io/hashicorp/azurerm/3.42.0/linux_amd64/terraform-provider-azurerm_v3.42.0_x5        
      displayName: ejemplo

    - task: ms-devlabs.custom-terraform-tasks.custom-terraform-release-task.TerraformTaskV4@4
      displayName: 'Terraform : plan'
      inputs:
        command: plan
        commandOptions: '-var-file=$(Build.ArtifactStagingDirectory)/$(FileVar)'
        environmentServiceNameAzureRM: $(ServiceConnection)  
        workingDirectory: '$(Build.ArtifactStagingDirectory)'   

    - task: ms-devlabs.custom-terraform-tasks.custom-terraform-release-task.TerraformTaskV4@4
      displayName: 'Terraform : apply'
      inputs:
        command: apply
        workingDirectory: '$(Build.ArtifactStagingDirectory)'
        commandOptions: '-var-file=$(FileVar)'
        environmentServiceNameAzureRM: $(ServiceConnection)  

    - script: | 
        cd $(Build.ArtifactStagingDirectory)
        ls        
      displayName: ejemplo        

